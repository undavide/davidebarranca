<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>HTML Panel Tips #23: JavascriptObfuscator API Gulp.js Plugin | Davide Barranca &mdash; Photoshop, etc. </title>
    <meta property="og:title" content="HTML Panel Tips #23: JavascriptObfuscator API Gulp.js Plugin | Davide Barranca &mdash; Photoshop, etc. " />
    <meta name="twitter:title" content="HTML Panel Tips #23: JavascriptObfuscator API Gulp.js Plugin | Davide Barranca &mdash; Photoshop, etc. " />

    <meta name="description" content="A Gulp.js Plugin consuming the JavascriptObfuscator HTTP API">
    <meta name="description" property="og:description" content="A Gulp.js Plugin consuming the JavascriptObfuscator HTTP API" />
    <meta name="twitter:description" content="A Gulp.js Plugin consuming the JavascriptObfuscator HTTP API" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:site" content="@undavide" />
    
    <meta property="og:url" content="http://localhost:4000/2017/02/html-panel-tips-23-javascriptobfuscator-api-gulp-js-plugin/" />

    <meta property="og:image" content="" />
    <meta name="twitter:image" content="" />

    <meta name="author" content="Davide Barranca" />

    <meta name="copyright" content="Copyright by Davide Barranca. All Rights Reserved." />

    <style>
        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 300;
            src: local('Roboto Light'), local('Roboto-Light'), url(https://fonts.gstatic.com/s/roboto/v15/Hgo13k-tfSpn0qi1SFdUfVtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 400;
            src: local('Roboto'), local('Roboto-Regular'), url(https://fonts.gstatic.com/s/roboto/v15/CWB0XYA8bzo0kSThX0UTuA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 700;
            src: local('Roboto Bold'), local('Roboto-Bold'), url(https://fonts.gstatic.com/s/roboto/v15/d-6IYplOFocCacKzxwXSOFtXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: normal;
            font-weight: 900;
            src: local('Roboto Black'), local('Roboto-Black'), url(https://fonts.gstatic.com/s/roboto/v15/mnpfi9pxYH-Go5UiibESIltXRa8TVwTICgirnJhmVJw.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 300;
            src: local('Roboto Light Italic'), local('Roboto-LightItalic'), url(https://fonts.gstatic.com/s/roboto/v15/7m8l7TlFO-S3VkhHuR0at44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 400;
            src: local('Roboto Italic'), local('Roboto-Italic'), url(https://fonts.gstatic.com/s/roboto/v15/vPcynSL0qHq_6dX7lKVByfesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 700;
            src: local('Roboto Bold Italic'), local('Roboto-BoldItalic'), url(https://fonts.gstatic.com/s/roboto/v15/t6Nd4cfPRhZP44Q5QAjcC44P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }

        @font-face {
            font-family: 'Roboto';
            font-style: italic;
            font-weight: 900;
            src: local('Roboto Black Italic'), local('Roboto-BlackItalic'), url(https://fonts.gstatic.com/s/roboto/v15/bmC0pGMXrhphrZJmniIZpY4P5ICox8Kq3LLUNMylGO4.woff2) format('woff2');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
        }
    </style>
    
    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" />
    
    <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

    <link rel="canonical" href="http://localhost:4000/2017/02/html-panel-tips-23-javascriptobfuscator-api-gulp-js-plugin/">

    <link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

    
</head>


    <body>
        <div class="wrapper">
            <aside class="user-profile fixed" role="complementary">
    <div class="burger">
        <input class="trigger hidden" id="toggleBurger" type="checkbox" />
        <label for="toggleBurger">
            <span>Navigation</span>
        </label>
    </div>

    <div class="compact-header">
        <a class="avatar" href="http://localhost:4000"><img alt="Avatar" src="/assets/img/io.jpg" /></a>
        <div class="my-info">
            <strong class="my-name">Davide Barranca</strong>
            <span class="my-job-title">Photoshop, etc.</span>
        </div>
    </div>

    
        
        <div class="mainmenu">
            <a href="http://localhost:4000" >Home</a>
            
                
            
                
            
                
            
                
                    <a href="http://localhost:4000/books/" >Books</a>
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </div>
        
    

    <p class="about-me">Digital Caveman. Photoshop retoucher and script/panels developer. I also publish courses, check the Books page!</p>

    <ul class="socials">
        <li><a href="https://www.facebook.com/undavide"><svg title="facebook" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></li><li><a href="https://twitter.com/undavide"><svg title="twitter" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li><li><a href="https://github.com/undavide"><svg title="github" width="16" height="16" ><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#github-icon"></use></svg></a></li>

        
            <li><a href="mailto:davide.barranca@gmail.com"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#email-icon"></use></svg></a></li>
        

        
         <li><a href="http://localhost:4000/feed.xml"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#rss-icon"></use></svg></a></li>
        
    </ul>
</aside>

            <main class="the-content" role="main">
                <div class="search" role="search">
    <div>
        <div class="show-results-count">0 Results</div>
        <div class="search-holder">
            <input type="text" id="search-input" placeholder="search for..." />
        </div>
    </div>
    <ul id="results-container" class="results-container"></ul>
</div>


                <article class="post single" role="article" itemscope itemtype="http://schema.org/BlogPosting">
    <header class="post-header">
        <ul>
            <li><time datetime="2017-02-11T01:06:28+01:00" itemprop="datePublished">11 Feb, 2017</time></li>
            
                
                <li class="cats">
                    
                        <a href="/categories/CEP/">CEP</a>
                    
                </li>
                
            
        </ul>
        <h2 itemprop="name headline">HTML Panel Tips #23: JavascriptObfuscator API Gulp.js Plugin</h2>
    </header>

    <div class="post-content">
        <p>When developing HTML Panels, I’m always quite fanatic about code privacy: for a variety of reasons, I don’t want users to peek into my files. Lately, I’ve found particularly effective the obfuscation provided by <a href="https://javascriptobfuscator.com">javascriptobfuscator.com</a> – which, surprisingly, works equally fine with both JavaScript <em>and</em> ExtendScript.</p>

<p>Their paid tier offers the possibility to access it through HTTP – a good candidate for Gulp automation. Since there’s no ready-made plugin available on the internet, I’ve ventured into building one; which I’m going to share with you in this post. Before going into the technical details of Gulp plugins, let me recap very briefly my point of view on code privacy.</p>

<ol>
  <li>HTML Panels should protect both JS and JSX, and JSX is known to be particularly resistant to aggressive minification and/or obfuscation.</li>
  <li>To my experience, free obfuscation services are not that much reliable: even the apparently ugliest result can be automatically beautified in such a way that at least part of the code logic is exposed. Moreover, some of them are known to inject malicious code in the process.</li>
  <li> I’ve evaluated two or three different options, and I’ve finally chosen the one I’ll talk about. I’m not sponsored in any way – alas :-)</li>
  <li>No, JSXBIN isn’t as secure as it was in the past.</li>
</ol>

<p>Please note that I’ll assume Gulp knowledge – I’ve already written about it <a href="/2014/08/html-panels-tips-13-automate-zxp-packaging-with-gulp-js/">here</a>, please check that if you find yourself lost. That said, let’s see the example code they provide <a href="https://javascriptobfuscator.com/downloads.aspx">on this page</a>, that I’ll use as a starting point – it’s the Javascript Obfuscator API Example Project (HTTP + JSON API). The following is found in a script tag of an html page.</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">proj</span> <span class="o">=</span> <span class="p">{};</span>

<span class="nx">proj</span><span class="p">.</span><span class="nx">APIKey</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span> <span class="c1">// &lt;- your API Key</span>
<span class="nx">proj</span><span class="p">.</span><span class="nx">APIPwd</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span> <span class="c1">// &lt;- your API Password</span>
<span class="nx">proj</span><span class="p">.</span><span class="nx">Name</span> <span class="o">=</span> <span class="s2">"Sample1"</span><span class="p">;</span>
<span class="nx">proj</span><span class="p">.</span><span class="nx">ReplaceNames</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

<span class="c1">// for more parameters of the proj object , please reference</span>
<span class="c1">// http://service.javascriptobfuscator.com/httpapi.asmx?WSDL</span>

<span class="kd">var</span> <span class="nx">item0</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">();</span>
<span class="nx">item0</span><span class="p">.</span><span class="nx">FileName</span> <span class="o">=</span> <span class="s2">"test0.js"</span><span class="p">;</span>
<span class="nx">item0</span><span class="p">.</span><span class="nx">FileCode</span> <span class="o">=</span> <span class="s2">"function hello(x,y){var z=11;return x+y+z;}"</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">item1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Object</span><span class="p">();</span>
<span class="nx">item1</span><span class="p">.</span><span class="nx">FileName</span> <span class="o">=</span> <span class="s2">"test1.js"</span><span class="p">;</span>
<span class="nx">item1</span><span class="p">.</span><span class="nx">FileCode</span> <span class="o">=</span> <span class="s2">"var strs=['aaaa','bbbb','cccc','dddd','eeee','abcdefghijklmnopqrstuvwxyz0123456789']"</span><span class="p">;</span>

<span class="nx">proj</span><span class="p">.</span><span class="nx">Items</span> <span class="o">=</span> <span class="p">[</span><span class="nx">item0</span><span class="p">,</span> <span class="nx">item1</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">"https://service.javascriptobfuscator.com/HttpApi.ashx"</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"POST"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span> <span class="s2">"text/json"</span><span class="p">);</span>
<span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">proj</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">alert</span><span class="p">(</span><span class="s2">"Http Error :"</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">+</span> <span class="s2">"</span><span class="err">\</span><span class="s2">r</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">Type</span> <span class="o">!=</span> <span class="s2">"Succeed"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="s2">" ERROR : "</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Type</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">ErrorCode</span> <span class="o">+</span> <span class="s2">":"</span> <span class="o">+</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Message</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"DIV"</span><span class="p">);</span>
      <span class="nx">div</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="s2">"margin:12px;border-bottom:solid 1px gray;"</span><span class="p">;</span>
      <span class="nx">div</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">FileCode</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Let’s inspect this. First, you need your API Key and API Password, that you can find in your JavascriptObfuscator dashboard, as soon as you’ve subscribed to one of the paid tiers. A <code class="highlighter-rouge">proj</code> object is created, and some properties assigned: your API data, the project name, and a series of parameters that will drive the obfuscation process. In this case, <code class="highlighter-rouge">ReplaceName</code> set to <code class="highlighter-rouge">true</code> (line 6). In the same call, you can send for processing more that one single file: they must be wrapped with an object (here <code class="highlighter-rouge">item0</code> and <code class="highlighter-rouge">item1</code>), which actual code is found in the <code class="highlighter-rouge">FileCode</code> property (lines 11-17).</p>

<p>Then they’re both stored into an array that is assigned to the <code class="highlighter-rouge">proj.Items</code> property. Next, a standard <code class="highlighter-rouge">XMLHttpRequest</code> of type <code class="highlighter-rouge">POST</code> is sent, passing the stringified <code class="highlighter-rouge">proj</code> object (line 26). The response is then showed in a couple of <code class="highlighter-rouge">div</code> elements in the page. Enough for this example. The kind of API that I’d like to consume in my real code is as follows – this comes directly, yet slightly simplified, from my <code class="highlighter-rouge">gulpfile.js</code></p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">gulp</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'gulp'</span><span class="p">),</span>
    <span class="nx">jso</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./jsobfuscator'</span><span class="p">);</span>

<span class="c1">// several previous tasks here...</span>

<span class="nx">gulp</span><span class="p">.</span><span class="nx">task</span><span class="p">(</span><span class="s1">'jso'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">gulp</span><span class="p">.</span><span class="nx">src</span><span class="p">([</span>
    <span class="s1">'src/app/jsx/photoshop.jsx'</span><span class="p">,</span>
    <span class="s1">'src/app/app.js'</span><span class="p">,</span>
  <span class="p">],</span> <span class="p">{</span> <span class="na">base</span><span class="p">:</span> <span class="s1">'./src/'</span> <span class="p">})</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">jso</span><span class="p">())</span>
  <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">gulp</span><span class="p">.</span><span class="nx">dest</span><span class="p">(</span><span class="s2">"dist"</span><span class="p">))</span>
<span class="p">});</span></code></pre></figure>

<p>I’m passing two files in the source array – the ones I’m interested in deep obfuscating: the main application JS, and the only JSX of the Panel. The processed result is going to be saved in the <code class="highlighter-rouge">dist</code> folder, keeping the same directories structure. As you see, I’m requiring <code class="highlighter-rouge">'./jsobfuscator'</code>: this means that I’ve created in the root folder a <code class="highlighter-rouge">jsobfuscator.js</code> file, which contains my actual Gulp plugin. The entire code is as follows, read along for a walkthrough.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/53958afcf504a528ebede3b6c5e46845.js"> </script>

<p>Before going any further, check this <a href="https://github.com/gulpjs/gulp/tree/master/docs/writing-a-plugin">Writing a Gulp Plugin</a> documentation page as a way to orient yourself: I’ll point out the main problems I’ve run into as a total Gulp plugins beginner, that I’ve been able to solve after a good deal of head scratching time. First, you need to require some modules: the native <code class="highlighter-rouge">fs</code>, <code class="highlighter-rouge">stream</code>, and <code class="highlighter-rouge">http</code>, plus <code class="highlighter-rouge">through2</code>, <code class="highlighter-rouge">gulp-util</code>, and <code class="highlighter-rouge">vinyl</code> – install them:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">npm <span class="nb">install</span> <span class="nt">--save-dev</span> through2 vinyl gulp-util</code></pre></figure>

<p>I’m exporting a single function, that returns (line 84) the <code class="highlighter-rouge">transform</code> function passed <em>through</em> the <code class="highlighter-rouge">through.obj()</code> method: this is the way a Gulp plugin works.</p>

<figure class="alignright">
	<img width="250" src="/wp-content/uploads/2017/02/JSOParams.png" />
</figure>

<p>The <code class="highlighter-rouge">transform</code> function (line 10) is exactly where everything happens. I’ve recreated there the <code class="highlighter-rouge">proj</code> object you’ve seen in the demo file, passing a lot more parameters. These ones (lines 21-29, like <code class="highlighter-rouge">MoveStrings</code>, <code class="highlighter-rouge">DeepObfuscate</code>, etc.) should mimic the setup illustrated in the screenshot at right, that comes from the JavascriptObfuscator Windows-only GUI.</p>

<p>That’s what you’re allowed to set with a Basic membership ($19 per month). I’m not 100% sure I’ve been able to replicate everything: if you have a better understanding of the parameters, please let me know in the comments. Next, I’ve created the wrapper object (<code class="highlighter-rouge">appJS</code>, line 31) that will contain the plain code to be obfuscated: please note that the <code class="highlighter-rouge">FileCode</code> property this time can’t be just equal to <code class="highlighter-rouge">file</code>, which is a peculiar object called <a href="https://github.com/gulpjs/vinyl">Vinyl File</a> – what your Plugin should receive and, eventually, return. Instead, you’re interested into the <code class="highlighter-rouge">contents</code> prop of the Vinyl File, which happens to be a <a href="https://docs.nodejitsu.com/articles/advanced/buffers/how-to-use-buffers/">Buffer</a>: so you need to stringify it, passing the correct encoding (<code class="highlighter-rouge">'utf8'</code>).</p>

<p>At line 35, <code class="highlighter-rouge">appJS</code> is inserted in the <code class="highlighter-rouge">proj.Items</code> array; I’m then creating a <code class="highlighter-rouge">postData</code> variable, that holds the String I’ll eventually need to POST to the  JavascriptObfuscator server – the stringified version of the entire <code class="highlighter-rouge">proj</code> object. Line 41-49, the <code class="highlighter-rouge">options</code> object will be needed in the request at line 80: I have to specify the host (no prepended https), path, method, and headers. Without <code class="highlighter-rouge">'Content-Type'</code> and <code class="highlighter-rouge">'Content-Length'</code> (see <a href="http://stackoverflow.com/questions/17283040/updating-post-http-request-length-in-node-js">this StackOverflow thread</a> for the <code class="highlighter-rouge">Buffer.byteLength()</code> method used to calculate the latter) the request will fail. Line 49, <code class="highlighter-rouge">postCallback</code> is called when the request is dispatched.</p>

<p>As soon as data is coming, i.e. <code class="highlighter-rouge">response.on('data')</code>, a string is formed. When the response is terminated, i.e. <code class="highlighter-rouge">response.on('end')</code>, I’m parsing the received JSON string into an object (line 62). If you want to log it – or log anything to debug your code – use the <code class="highlighter-rouge">gutil.log()</code> function, that you can find in the code comments here and there. The horribly, properly obfuscated string is found in the <code class="highlighter-rouge">resObj.Items[0].FileCode</code> prop, hurray! The only problem is, as I’ve mentioned earlier, that your Gulp plugin needs to return a Vinyl File. Hence, a brand new Vinyl File called <code class="highlighter-rouge">jsFile</code> is created (line 66) using current working directory, base, and path from the original <code class="highlighter-rouge">file</code>. What about the <code class="highlighter-rouge">contents</code>? You cannot stick in there the <code class="highlighter-rouge">resObj.Items[0].FileCode</code> String, because contents must be a Stream. Thanks to the <a href="http://stackoverflow.com/a/25650163/2715135">holy StackOverflow</a>, I’ve learned that a <code class="highlighter-rouge">Readable</code> (line 64) can turn String into Stream, and I’m a happy camper now.</p>

<p>Last but not least, this Vinyl file must be pushed down the line, for the Gulp Plugin to work. Was I not into a callback, nested in a function, which in turn is nested into the main <code class="highlighter-rouge">transform</code> function, I would have used <code class="highlighter-rouge">this.push(jsFile)</code>. But I happen to be at a location where <code class="highlighter-rouge">this</code> is not what it used to be: that’s the why I’ve stored it (line 15) into the <code class="highlighter-rouge">that</code> variable. So <code class="highlighter-rouge">that.push(jsFile)</code>, line 75. At the very end, you need to run the <code class="highlighter-rouge">transform</code>’s callback (line 76), and you can call quit.</p>

<hr />

<p>The above took me more than a full day of work to figure out… It’s been a self-taught crash course on Gulp Plugins – worth sharing to you and my future self when I’ll have forgotten every juicy detail of it; in about… a couple of months maybe? There is plenty of room for improvement – I would have liked to merge multiple source files not into a single file, but into a single http request: splitting the various input files into several elements of the <code class="highlighter-rouge">proj.Items</code> array. Yet, I have no idea how to do so (suggestions in the comments are welcome!). Error checking is completely missing, and so on and so forth. Rough as it is, it works; and every second saved from manual labor is worth the effort, isn’t it?</p>

<hr />

<h3 id="the-photoshop-html-panels-development-course">The Photoshop HTML Panels Development Course</h3>

<figure class="alignleft">
  <a href="https://htmlpanelsbook.com" target="_blank">
	<img src="/wp-content/uploads/2016/03/BookVideo.jpg" alt="Photoshop HTML Panels Development course" /></a>
	<figcaption>Updated to CC 2019.</figcaption>
</figure>

<p>If you’re reading here, you might be interested in my Photoshop Panels development – so let me inform you that I’ve authored a full course:</p>

<ul>
  <li><strong>300 pages</strong> PDF</li>
  <li><strong>3 hours</strong> of HD screencasts</li>
  <li><strong>28 custom Panels</strong> with commented code</li>
</ul>

<p><a href="http://htmlpanelsbook.com">Check it out!</a> Please help me spread the news – I’ll be able to keep producing more exclusive content on this blog. Thank you!</p>


    </div>

    <footer class="post-footer">
        <div class="share">Share
            <ul class="social-networks">
                <li class="share-facebook"><a href="https://www.facebook.com/sharer.php?s=100&p[title]=HTML Panel Tips #23: JavascriptObfuscator API Gulp.js Plugin&p[summary]=When developing HTML Panels, I’m always quite fanatic about code privacy: for a variety of reasons, I don’t want users to peek into my fi...&p[url]=http://localhost:4000/2017/02/html-panel-tips-23-javascriptobfuscator-api-gulp-js-plugin/" class="s_facebook" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#facebook-icon"></use></svg></a></li>
                <li class="share-twitter"><a href="http://twitter.com/share?url=http://localhost:4000/2017/02/html-panel-tips-23-javascriptobfuscator-api-gulp-js-plugin/&text=When developing HTML Panels, I’m always quite fanatic about code privacy: for a variety of reasons, I don’t want users to peek into my fi...&hashtags=Gulp,obfuscation,HTML Panels Tips," rel="noreferrer" target="_blank" onclick="window.open(this.href, '','width=700,height=300');return false;"><svg title="" width="16" height="16"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://localhost:4000/assets/svg/social-icons.svg#twitter-icon"></use></svg></a></li>
            </ul>
        </div>
        
        <div class="tags">
            <ul>
                
                <li><a href="http://localhost:4000/tag/Gulp">Gulp</a></li>
                
                <li><a href="http://localhost:4000/tag/obfuscation">obfuscation</a></li>
                
                <li><a href="http://localhost:4000/tag/HTML Panels Tips">HTML Panels Tips</a></li>
                
            </ul>
        </div>
        
    </footer>
</article>


<aside class="comments" role="complementary">
    <div id="disqus_thread"></div>
    <script>
        var disqus_config = function () {
            this.page.url = 'http://localhost:4000/2017/02/html-panel-tips-23-javascriptobfuscator-api-gulp-js-plugin/';
            this.page.identifier = '2/11/2017';
        };
        (function() {
            var d = document, s = d.createElement('script');

            s.src = '//your_disqus_site.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
</aside>


            </main>
        </div>

        <script src="http://localhost:4000/assets/js/jquery-1.12.2.min.js"></script>
<script src="http://localhost:4000/assets/js/backtotop.js"></script>
<script src="http://localhost:4000/assets/js/lunr.min.js"></script>
<script src="http://localhost:4000/assets/js/lunr-feed.js"></script>
<script src="http://localhost:4000/assets/js/jquery.fitvids.js"></script>
<script src="http://localhost:4000/assets/js/svg4everybody.min.js"></script>
<script src="http://localhost:4000/assets/js/scripts.js"></script>


    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-XXXXXXX-2', 'auto');
        ga('send', 'pageview');
    </script>

    </body>
</html>